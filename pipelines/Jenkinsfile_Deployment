pipeline {
    agent any
    
    parameters {
        string(name: 'strVersao',
            defaultValue: 'stable',
            description: 'Número da Versão')
    }    
    
    environment{
        def dockerHome = "/usr" //tool name: 'dockerTool', type: 'org.jenkinsci.plugins.docker.commons.tools.DockerTool'
        def dockerExec = "${dockerHome}/bin/docker"  
        def awsExec = "/usr/local/bin/aws"
        def hadolintExec = "/bin/hadolint"
        def kraneExec = "/var/lib/gems/2.5.0/gems/krane-1.1.3/exe/krane"
        def workspace = pwd()
        def descriptorsk8s = "${workspace}/descriptors-k8s"
    }
    
    stages {
        stage('SCM Checkout'){
            steps{
                 checkout scm
            }
        }
        
        stage('Lint'){
            steps{
                sh "${hadolintExec} --ignore DL3013 Dockerfile"
            }
        }
        
        stage('Build Image'){
            steps{
                sh "${dockerExec} build --tag=thedevices/app-python-demo:${params.strVersao} ."
            }
        }
        
        stage('Push Image to DockerHub'){
            steps{
                withCredentials([string(credentialsId: 'dockerhub-credential', variable: 'dockerHubPassword')]) {
                    sh "${dockerExec} login -u thedevices -p ${dockerHubPassword}"
                    sh "${dockerExec} push thedevices/app-python-demo:${params.strVersao}"
                }
            }
        }
        stage('Deploy'){
            steps{
                sh "chmod +x ./run_deploy.sh"
                sh "./run_deploy.sh"
            }
        }
    }    
    
}
